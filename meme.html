
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Meme Generator — HashHero (Fixed)</title>
  <meta name="description" content="Upload or choose a template, add draggable text, and download your meme." />
  <link rel="stylesheet" href="/assets/css/site.css" />
  <style>
    :root { --bg:#0f1220; --card:#151932; --text:#e8ebff; --muted:#9aa3c7; --border:rgba(255,255,255,.08); }
    body { background:var(--bg); color:var(--text); margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;}
    .container { max-width:1150px; margin:0 auto; padding:24px; }
    header { position: sticky; top:0; backdrop-filter: blur(6px); background: rgba(15,18,32,0.7); border-bottom: 1px solid rgba(255,255,255,0.06); z-index: 50; }
    .nav { display:flex; align-items:center; justify-content:space-between; gap:16px; padding: 14px 24px; }
    .brand { font-weight:800; } .brand a { color:var(--text); text-decoration:none; }
    .menu { display:flex; gap:14px; flex-wrap:wrap; }
    .menu a { color:#b9c2ea; text-decoration:none; padding:8px 10px; border-radius:12px; }
    .menu a.active,.menu a:hover { color:var(--text); background:rgba(122,162,255,.12); }
    .grid { display:grid; gap:16px; grid-template-columns:360px 1fr; } @media(max-width:980px){ .grid{ grid-template-columns:1fr; } }
    .card { background:var(--card); border:1px solid var(--border); border-radius:18px; padding:18px; }
    .muted { color:var(--muted); }
    input,select,button { background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); color:var(--text); padding:10px 12px; border-radius:12px; }
    button { cursor:pointer; }
    .pill { display:inline-flex; align-items:center; gap:6px; font-size:12px; padding:6px 10px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); border-radius:12px; }
    .template-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; }
    .template { border:1px solid var(--border); border-radius:12px; overflow:hidden; cursor:pointer; background: rgba(255,255,255,0.03); }
    .template img { display:block; width:100%; height:100%; object-fit:cover; aspect-ratio:1/1; }
    canvas { width:100%; background:#000; border-radius:18px; border:1px solid var(--border); }
    .small{font-size:12px;} .help{font-size:12px;color:var(--muted);}
    .status { font-size:12px; color:#ffb4b4; margin-top:8px; min-height:1.2em; }
  </style>
</head>
<body>
  <header>
    <nav class="nav container">
      <div class="brand"><a href="/">HashHero</a></div>
      <div class="menu">
        <a href="/">Generator</a>
        <a href="/ask.html">Ask&nbsp;AI</a>
        <a href="/qr.html">QR</a>
        <a href="/timer.html">Timer</a>
        <a href="/audio.html">Audio</a>
        <a class="active" href="/meme.html">Meme</a>
        <a href="/about.html">About</a>
      </div>
    </nav>
  </header>

  <main class="container">
    <div class="grid">
      <section class="card">
        <h1 style="margin:0 0 6px 0;">Meme Generator</h1>
        <p class="muted" style="margin:0 0 10px 0;">Upload an image or pick a template. Add draggable text and download.</p>

        <label for="file">Upload image</label>
        <input id="file" type="file" accept="image/*">

        <div style="margin-top:10px;">
          <div style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;">
            <div style="display:flex; gap:8px;">
              <button class="pill" id="tabBuiltIn">Built-in</button>
              <button class="pill" id="tabTrending">Trending</button>
            </div>
            <div style="display:flex; gap:8px;">
              <input id="tplSearch" type="text" placeholder="Search templates… (e.g., drake, distracted)" style="min-width:220px;">
              <button class="pill" id="clearTemplate">Clear</button>
            </div>
          </div>
          <div class="template-grid" id="templates"></div>
          <div class="help">Built-in templates work offline. <strong>Trending</strong> pulls popular templates from Imgflip. If a template image can’t load due to CORS, click “Open”, download it, then upload.</div>
        </div>

        <hr style="border-color: rgba(255,255,255,0.08); margin:16px 0;">

        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <button class="pill" id="addText">+ Add text</button>
          <button class="pill" id="resetPositions">Reset positions</button>
          <label style="display:inline-flex; align-items:center; gap:6px;">
            <input type="checkbox" id="upper" checked> UPPERCASE
          </label>
        </div>

        <div style="margin-top:10px;">
          <label>Font size</label>
          <input id="fontSize" type="range" min="10" max="120" value="48">
        </div>
        <div>
          <label>Outline</label>
          <input id="outline" type="range" min="0" max="12" value="6">
        </div>
        <div>
          <label>Align</label>
          <select id="align">
            <option value="center">Center</option>
            <option value="left">Left</option>
            <option value="right">Right</option>
          </select>
        </div>

        <div style="margin-top:10px;">
          <input id="watermarkText" type="text" placeholder="Watermark (optional, e.g., hashhero)">
          <label style="display:inline-flex; align-items:center; gap:6px;">
            <input type="checkbox" id="wm"> Enable watermark
          </label>
        </div>

        <hr style="border-color: rgba(255,255,255,0.08); margin:16px 0;">

        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button id="downloadPng">Download PNG</button>
          <button id="downloadJpg">Download JPG</button>
        </div>

        <div id="status" class="status"></div>

        <div id="textList" style="margin-top:14px;"></div>
      </section>

      <section class="card">
        <canvas id="c" width="1000" height="1000"></canvas>
      </section>
    </div>
  </main>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const statusEl = document.getElementById('status');
    function setStatus(msg){ statusEl.textContent = msg || ''; }
    function ok(el,id){ if(!el) setStatus('Missing element: '+id); return !!el; }

    const canvas = document.getElementById('c');
    const ctx = canvas?.getContext('2d');
    const fileInput = document.getElementById('file');
    const templatesEl = document.getElementById('templates');
    const addTextBtn = document.getElementById('addText');
    const textList = document.getElementById('textList');
    const resetBtn = document.getElementById('resetPositions');
    const upperCb = document.getElementById('upper');
    const fontSizeRange = document.getElementById('fontSize');
    const outlineRange = document.getElementById('outline');
    const alignSel = document.getElementById('align');
    const wmCb = document.getElementById('wm');
    const wmText = document.getElementById('watermarkText');
    const clearTemplateBtn = document.getElementById('clearTemplate');
    const tabBuiltIn = document.getElementById('tabBuiltIn');
    const tabTrending = document.getElementById('tabTrending');
    const tplSearch = document.getElementById('tplSearch');

    if (![canvas, ctx, fileInput, templatesEl, addTextBtn, resetBtn, tabBuiltIn, tabTrending].every(Boolean)) {
      setStatus('Initialization failed. Please refresh the page.');
      return;
    }

    // State
    let img = null;
    let texts = [];
    let activeId = null;
    let activeTab = 'built';
    let trendingTemplates = [];

    // Built-in templates
    const TEMPLATES = [
      { name: 'Top/Bottom (classic)', data: makeSolidTemplate('#222', 1000, 1000) },
      { name: 'Two Panel', data: makeTwoPanelTemplate(1000, 1000) },
      { name: 'Four Panel', data: makeFourPanelTemplate(1000, 1000) }
    ];

    function makeSolidTemplate(color, w, h) {
      const cnv = document.createElement('canvas'); cnv.width = w; cnv.height = h;
      const c2 = cnv.getContext('2d'); c2.fillStyle = color; c2.fillRect(0,0,w,h);
      return cnv.toDataURL('image/png');
    }
    function makeTwoPanelTemplate(w, h) {
      const cnv = document.createElement('canvas'); cnv.width = w; cnv.height = h;
      const c2 = cnv.getContext('2d');
      c2.fillStyle = '#111'; c2.fillRect(0,0,w,h);
      c2.fillStyle = '#333'; c2.fillRect(0,0,w,h/2);
      c2.strokeStyle='rgba(255,255,255,0.2)'; c2.lineWidth=4; c2.strokeRect(2,2,w-4,h-4);
      return cnv.toDataURL('image/png');
    }
    function makeFourPanelTemplate(w, h) {
      const cnv = document.createElement('canvas'); cnv.width = w; cnv.height = h;
      const c2 = cnv.getContext('2d');
      c2.fillStyle = '#111'; c2.fillRect(0,0,w,h);
      c2.fillStyle = '#2a2a2a'; c2.fillRect(0,0,w/2,h/2);
      c2.fillStyle = '#3a3a3a'; c2.fillRect(w/2,0,w/2,h/2);
      c2.fillStyle = '#2f2f2f'; c2.fillRect(0,h/2,w/2,h/2);
      c2.fillStyle = '#383838'; c2.fillRect(w/2,h/2,w/2,h/2);
      c2.strokeStyle='rgba(255,255,255,0.2)'; c2.lineWidth=4; c2.strokeRect(2,2,w-4,h-4);
      return cnv.toDataURL('image/png');
    }

    function renderTemplatesBuilt() {
      templatesEl.innerHTML = TEMPLATES.map((t,i)=>`
        <div class="template" data-built="${i}">
          <img src="${t.data}" alt="${t.name}">
          <div style="padding:8px" class="small muted">${t.name}</div>
        </div>`).join('');
      templatesEl.querySelectorAll('[data-built]').forEach(el => {
        el.addEventListener('click', () => {
          const t = TEMPLATES[+el.dataset.built];
          loadImage(t.data);
        });
      });
    }

    async function fetchTrending() {
      try {
        const res = await fetch('https://api.imgflip.com/get_memes', { mode: 'cors', cache: 'no-store' });
        const data = await res.json();
        if (data?.success && Array.isArray(data.data?.memes)) {
          trendingTemplates = data.data.memes.filter(m => m.box_count <= 4).slice(0, 60);
        } else {
          setStatus('Could not load trending templates.');
        }
      } catch (e) {
        setStatus('Trending templates blocked by network. Use Built-in or Upload.');
      }
    }

    function renderTemplatesTrending() {
      const q = (tplSearch.value || '').toLowerCase().trim();
      let arr = trendingTemplates;
      if (q) arr = arr.filter(m => m.name.toLowerCase().includes(q));
      if (!arr.length) {
        templatesEl.innerHTML = '<div class="small muted">No templates found. Try a different search.</div>';
        return;
      }
      templatesEl.innerHTML = arr.map(m => `
        <div class="template" data-url="${encodeURIComponent(m.url)}" style="cursor:pointer;">
          <img src="${m.url}" alt="${m.name}" data-url="${encodeURIComponent(m.url)}">
          <div style="padding:8px; display:flex; align-items:center; justify-content:space-between;">
            <span class="small muted" title="${m.name}">${m.name}</span>
            <div style="display:flex; gap:6px;">
              <button class="pill small" data-use="${encodeURIComponent(m.url)}">Use</button>
              <a class="pill small" href="${m.url}" target="_blank" rel="noopener">Open</a>
            </div>
          </div>
        </div>`).join('');
      // Clicking "Use" button
      templatesEl.querySelectorAll('[data-use]').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          const url = decodeURIComponent(btn.getAttribute('data-use'));
          const blobUrl = await safeLoadToBlobUrl(url);
          if (blobUrl) loadImage(blobUrl, true);
          else loadImage(url);
        });
      });
      // Clicking the card or image also selects
      templatesEl.querySelectorAll('.template, .template img').forEach(el => {
        el.addEventListener('click', async (e) => {
          const encoded = e.target.getAttribute('data-url') || e.currentTarget.getAttribute('data-url');
          if (!encoded) return;
          const url = decodeURIComponent(encoded);
          const blobUrl = await safeLoadToBlobUrl(url);
          if (blobUrl) loadImage(blobUrl, true);
          else loadImage(url);
        }, { passive: true });
      });
    }

    async function safeLoadToBlobUrl(url) {
      try {
        const res = await fetch(url, { mode: 'cors' });
        if (!res.ok) return null;
        const blob = await res.blob();
        return URL.createObjectURL(blob);
      } catch { return null; }
    }

    function setTab(tab) {
      activeTab = tab;
      if (tab === 'built') {
        renderTemplatesBuilt();
      } else {
        if (!trendingTemplates.length) { fetchTrending().then(renderTemplatesTrending); }
        else { renderTemplatesTrending(); }
      }
    }

    function addTextBox(initial='NEW TEXT', y=80) {
      const id = Math.random().toString(36).slice(2,9);
      texts.push({ id, x: canvas.width/2, y, text: initial, size: +fontSizeRange.value, align: alignSel.value });
      activeId = id;
      renderTextList();
      draw();
    }

    function renderTextList() {
      textList.innerHTML = texts.map(t => `
        <div class="card" style="margin-top:8px;">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
            <div class="small muted">Text box</div>
            <button class="pill small" data-del="${t.id}">Delete</button>
          </div>
          <div style="margin-top:8px;">
            <input type="text" data-id="${t.id}" value="${t.text.replace(/"/g,'&quot;')}" style="width:100%;">
          </div>
        </div>`).join('');
      textList.querySelectorAll('[data-del]').forEach(btn => btn.addEventListener('click', () => {
        const id = btn.getAttribute('data-del');
        texts = texts.filter(x => x.id !== id);
        if (activeId === id) activeId = texts[0]?.id || null;
        renderTextList(); draw();
      }));
      textList.querySelectorAll('input[type="text"]').forEach(inp => {
        inp.addEventListener('input', () => {
          const id = inp.getAttribute('data-id');
          const t = texts.find(x => x.id === id);
          if (!t) return;
          t.text = inp.value;
          draw();
        });
        inp.addEventListener('focus', () => activeId = inp.getAttribute('data-id'));
      });
    }

    function fontSpec(size){ return `${size}px Impact, 'Anton', 'Arial Black', system-ui, sans-serif`; }
    function formatText(line){ return upperCb.checked ? (line || '').toUpperCase() : (line || ''); }

    function draw() {
      // background
      ctx.fillStyle = '#000'; ctx.fillRect(0,0,canvas.width, canvas.height);
      if (img) ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      else {
        const g = ctx.createLinearGradient(0,0,canvas.width, canvas.height);
        g.addColorStop(0,'#20243e'); g.addColorStop(1,'#10131f');
        ctx.fillStyle = g; ctx.fillRect(0,0,canvas.width, canvas.height);
        ctx.fillStyle = 'rgba(255,255,255,0.2)'; ctx.textAlign='center'; ctx.font='22px system-ui, sans-serif';
        ctx.fillText('Upload an image or pick a template', canvas.width/2, canvas.height/2);
      }
      // text
      const outline = +outlineRange.value;
      texts.forEach(t => {
        ctx.font = fontSpec(t.size); ctx.textAlign = t.align; ctx.textBaseline = 'middle';
        const lines = (t.text || '').split('\n'); const lh = t.size * 1.2;
        lines.forEach((line, idx) => {
          const yy = t.y + (idx - (lines.length-1)/2) * lh; const txt = formatText(line);
          if (outline > 0) { ctx.lineWidth = outline; ctx.strokeStyle = '#000'; ctx.strokeText(txt, t.x, yy); }
          ctx.fillStyle = '#fff'; ctx.fillText(txt, t.x, yy);
        });
      });
      // watermark
      if (wmCb.checked && wmText.value.trim()) {
        const s = Math.max(12, Math.round(canvas.width * 0.03));
        ctx.save(); ctx.globalAlpha = 0.65;
        ctx.font = `bold ${s}px system-ui, sans-serif`; ctx.fillStyle = 'rgba(255,255,255,0.6)';
        ctx.textAlign = 'right'; ctx.textBaseline = 'bottom';
        ctx.fillText(wmText.value.trim(), canvas.width - 14, canvas.height - 14);
        ctx.restore();
      }
    }

    function measureTextBox(t) {
      ctx.font = fontSpec(t.size);
      const lines = (t.text || '').split('\n');
      const widths = lines.map(line => ctx.measureText(formatText(line)).width);
      const w = Math.max(...widths, 1) + 20;
      const lineHeight = t.size * 1.2;
      const h = lines.length * lineHeight + 20;
      let x = t.x, left = 0;
      if (t.align === 'center') left = x - w/2;
      if (t.align === 'left') left = x;
      if (t.align === 'right') left = x - w;
      return { left, top: t.y - h/2, w, h, lineHeight, lines };
    }

    function hitTest(mx, my) {
      for (let i = texts.length -1; i >= 0; i--) {
        const t = texts[i];
        const box = measureTextBox(t);
        if (mx >= box.left && mx <= box.left + box.w && my >= box.top && my <= box.top + box.h) return t;
      }
      return null;
    }

    // Dragging
    let dragging = false, dragOffsetX = 0, dragOffsetY = 0;
    canvas.addEventListener('mousedown', startDrag);
    canvas.addEventListener('touchstart', (e) => startDrag(e.touches[0]));
    window.addEventListener('mousemove', moveDrag);
    window.addEventListener('touchmove', (e) => moveDrag(e.touches[0]));
    window.addEventListener('mouseup', endDrag);
    window.addEventListener('touchend', endDrag);

    function startDrag(e) {
      const r = canvas.getBoundingClientRect();
      const x = (e.clientX - r.left) * (canvas.width / r.width);
      const y = (e.clientY - r.top) * (canvas.height / r.height);
      const t = hitTest(x,y);
      if (t) { dragging = true; activeId = t.id; dragOffsetX = x - t.x; dragOffsetY = y - t.y; e.preventDefault(); }
    }
    function moveDrag(e) {
      if (!dragging) return;
      const r = canvas.getBoundingClientRect();
      const x = (e.clientX - r.left) * (canvas.width / r.width);
      const y = (e.clientY - r.top) * (canvas.height / r.height);
      const t = texts.find(x => x.id === activeId);
      if (t) { t.x = x - dragOffsetX; t.y = y - dragOffsetY; draw(); }
    }
    function endDrag(){ dragging = false; }

    // Controls
    addTextBtn.addEventListener('click', () => addTextBox('NEW TEXT'));
    resetBtn.addEventListener('click', () => { texts.forEach((t,i)=>{ t.x=canvas.width/2; t.y=i===0?80:canvas.height-80; }); draw(); });
    upperCb.addEventListener('change', draw);
    fontSizeRange.addEventListener('input', ()=>{ (activeId? [texts.find(x=>x.id===activeId)] : texts).forEach(t=> t && (t.size=+fontSizeRange.value)); draw(); });
    outlineRange.addEventListener('input', draw);
    alignSel.addEventListener('change', ()=>{ (activeId? [texts.find(x=>x.id===activeId)] : texts).forEach(t=> t && (t.align=alignSel.value)); draw(); });
    wmCb.addEventListener('change', draw);
    wmText.addEventListener('input', draw);

    // File upload
    fileInput.addEventListener('change', (e) => {
      const f = e.target.files?.[0];
      if (!f) { setStatus('No file selected.'); return; }
      const url = URL.createObjectURL(f);
      loadImage(url, true);
    });

    function loadImage(src, revoke=false) {
      setStatus('');
      const image = new Image();
      image.crossOrigin = 'anonymous';
      image.onload = () => {
        img = image;
        // fit canvas to image (max 1000)
        let w = image.width, h = image.height, max=1000;
        if (w > h) { if (w > max) { h = Math.round(h * (max / w)); w = max; } }
        else { if (h > max) { w = Math.round(w * (max / h)); h = max; } }
        canvas.width = w; canvas.height = h;
        if (!texts.length){ addTextBox('TOP TEXT'); addTextBox('BOTTOM TEXT', canvas.height - 120); }
        else { texts[0].y = 80; texts[texts.length-1].y = canvas.height - 80; }
        draw();
        if (revoke) setTimeout(()=>URL.revokeObjectURL(src), 1000);
      };
      image.onerror = () => setStatus('Could not load image. If this was a remote template, try “Open” then download and upload.');
      image.src = src;
    }

    // Tabs
    tabBuiltIn.addEventListener('click', () => setTab('built'));
    tabTrending.addEventListener('click', () => setTab('trend'));
    tplSearch.addEventListener('input', () => { if (activeTab==='trend') renderTemplatesTrending(); });
    clearTemplateBtn.addEventListener('click', () => { img = null; draw(); });

    // Defaults
    addTextBox('TOP TEXT');
    addTextBox('BOTTOM TEXT', canvas.height - 120);
    setTab('built');
    draw();

    // Download
    function download(type='image/png') {
      const link = document.createElement('a');
      link.download = 'hashhero-meme' + (type === 'image/png' ? '.png' : '.jpg');
      link.href = canvas.toDataURL(type, type === 'image/jpeg' ? 0.92 : undefined);
      link.click();
    }
    document.getElementById('downloadPng').addEventListener('click', () => download('image/png'));
    document.getElementById('downloadJpg').addEventListener('click', () => download('image/jpeg'));
  });
  </script>
</body>
</html>
